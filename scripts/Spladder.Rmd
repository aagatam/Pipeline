---
title: "SplAdder for neuropathy- figures and tables"
output:
  pdf_document: default
params:
  inpath: "../configs"

---


```{r "setup", include=FALSE}
#sudo apt-get install -y libcurl4-openssl-dev <-for curlr
#sudo apt-get install -y libxml2-dev <-for XML
packages<-c("knitr","RColorBrewer","VennDiagram","veccompare","ggplot2","pals","dplyr","matrixStats","gplots","UpSetR","XML","yaml")
package.check <- lapply(
  packages,
  FUN = function(x) {
    if (!require(x, character.only = TRUE)) {
      install.packages(x, dependencies = TRUE,repos = "http://cran.us.r-project.org")
      library(x, character.only = TRUE)
    }
  }
)
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager",repos = "http://cran.us.r-project.org")
BiocManager::install(version = "3.10")
listOfBiocPackages<-c("topGO","GOfuncR","annotate","biomaRt","GOfuncR")
notInstalled <- which( !listOfBiocPackages %in% rownames(installed.packages()) )
## check there's still something left to install
if( length(notInstalled) ) {
    BiocManager::install(listOfBiocPackages[ notInstalled ])
}
path_configs<-params$inpath

#opts_knit$set(root.dir = path)
knitr::opts_chunk$set(echo=FALSE)
```

```{r,warning=FALSE,message=FALSE,include=FALSE}

Description<-read.table(paste(path_configs,'/Description.csv',sep=''),header=TRUE,sep=';')
config<-read_yaml(paste(path_configs,'/config.yaml',sep=''),fileEncoding = "UTF-8")
spl_path<-paste(config$FINALOUTPUT,config$PROJECT,'genome/spladder',sep='/')
bb_path<-paste(config$FINALOUTPUT,config$PROJECT,'genome/bisbee',sep='/')

group='Spladder'
files<-list.files(path=spl_path,pattern='.txt$')
print(length(files))
i=1
events<-c('alt_3_prime','alt_5_prime','exon_skip','mult_exon_skip','mutex_exons')
for (event in events)
  {
    name_main<-paste(group,'_',event,sep='')
    # name2<-paste(group,'_',event,'_counts',sep='')
    # name3<-paste(group,'_',event,'_common',sep='')
    file.to.load<-read.table(paste(spl_path,'/',files[i],sep=''),header=TRUE)
    g=1
    for (col_name in Description$Group)
      {
        coll<-grep(col_name,colnames(file.to.load))
        name_var<-paste(Description$Condition[g],'_',Description$Batch[g],'_',Description$Repetition[g],sep='')
        colnames(file.to.load)<-sub(paste(col_name,"\\.",sep=''),name_var,colnames(file.to.load))#replace Spladder names with Description names
        g=g+1
      }
    print(files[i])
assign(name_main,file.to.load)
i=i+1
}



files2<-list.files(path=bb_path,pattern='*effects.csv')
files3<-list.files(path=bb_path,pattern='*peptides.csv')
for ( i in c(1:5))
{
  name<-paste(events[i],'_bisbee',sep='')
  file_read<-read.table(paste(bb_path,'/',files2[i],sep=''),header=TRUE,sep=',')
  file_read$event_id<-sub('(_)(\\d+$)','\\.\\2',file_read$event_id)


  namep<-paste(events[i],'_bisbee_pep',sep='')
  file_readp<-read.table(paste(bb_path,'/',files3[i],sep=''),header=TRUE,sep=',')
  file_readp$event_id<-sub('(_)(\\d+$)','\\.\\2',file_readp$event_id)

  file_read$refIso<-file_readp$refIsoform[match(file_read$event_id,file_readp$event_id)]

  assign(name,file_read)
  assign(namep,file_readp)
}


#Divide into 3 groups: both new, new+old, only old
PSI_NaO<-config$TH_PSI
sd_th<-config$TH_STD
res_NO<-matrix(nrow=9,ncol=5)
res_NN<-matrix(nrow=9,ncol=5)
res_OO<-matrix(nrow=9,ncol=5)

i=1
for (sdTH in sd_th)
{
  j=1
  for (event in c('alt_3_prime','alt_5_prime','exon_skip','mult_exon_skip','mutex_exons'))
  {
  name_main<-paste(group,'_',event,sep='')
  spladder_res<-get(name_main)
  name_bisbee<-paste(event,'_bisbee',sep='')
  bisbee_res<-get(name_bisbee)
  name_both_new<-paste(event,'_both_new',sep='')
  name_both_known<-paste(event,'_both_known',sep='')
  name_newAndOld<-paste(event,'_newAndOld',sep='')
  #Both old- IsoformSwitch,NonCoding, Noncoding_Iso2, Noncoding_Iso1
  #Both new Unknown Unknown_noncoding
  # New and Old NovelIso2, NovelIso1, NovelIso2_NonCoding1, NovelIso1_NonCoding2
  bisbee_both_new<-bisbee_res[which(bisbee_res$coding_transcript_effect=='Unknown' | bisbee_res$coding_transcript_effect=='Unknown_noncoding?'),]
  
  bisbee_both_known<-bisbee_res[which(bisbee_res$coding_transcript_effect=='IsoformSwitch'| bisbee_res$coding_transcript_effect=='NonCoding' | bisbee_res$coding_transcript_effect=='Noncoding_Iso1' | bisbee_res$coding_transcript_effect=='Noncoding_Iso2' ),]
  
  bisbee_newAndOld<-bisbee_res[which(bisbee_res$coding_transcript_effect=='NovelIso1'| bisbee_res$coding_transcript_effect=='NovelIso2' | bisbee_res$coding_transcript_effect=='NovelIso2_NonCoding1'| bisbee_res$coding_transcript_effect=='NovelIso1_NonCoding2'),]
  spladder_both_new<-spladder_res[spladder_res$event_id%in%bisbee_both_new$event_id,]
  spladder_both_known<-spladder_res[spladder_res$event_id%in%bisbee_both_known$event_id,]
  spladder_newAndOld<-spladder_res[spladder_res$event_id%in%bisbee_newAndOld$event_id,]

  #assign effect type
  spladder_both_new$effect_type<-bisbee_both_new$coding_transcript_effect[match(spladder_both_new$event_id,bisbee_both_new$event_id)]
  spladder_newAndOld$effect_type<-bisbee_newAndOld$coding_transcript_effect[match(spladder_newAndOld$event_id,bisbee_newAndOld$event_id)]
  spladder_both_known$effect_type<-bisbee_both_known$coding_transcript_effect[match(spladder_both_known$event_id,bisbee_both_known$event_id)]
  #assign refIso
  spladder_both_new$refIso<-NaN
  spladder_newAndOld$refIso<-bisbee_newAndOld$refIso[match(spladder_newAndOld$event_id,bisbee_newAndOld$event_id)]
  spladder_both_known$refIso<-bisbee_both_known$refIso[match(spladder_both_known$event_id,bisbee_both_known$event_id)]
  NA_val<-which(is.na(spladder_newAndOld$refIso))
  spladder_newAndOld[NA_val,]$refIso<-spladder_newAndOld[NA_val,]$effect_type
  #Recalculate PSI according to event type
  spladder_newAndOld$PSI_flipped='No'
  #A=Iso1, refIso=Iso2
  if (event == 'mutex_exons')
  {
    indices<-grep('.psi',colnames(spladder_newAndOld))
    for (h in c(1:dim(spladder_newAndOld)[1]))
      {
        if (spladder_newAndOld[h,]$refIso=='iso1' || length(grep('Iso2',spladder_newAndOld[h,]$effect_type))==1)
          {
            spladder_newAndOld[h,indices]<-1-spladder_newAndOld[h,indices]
            spladder_newAndOld[h,]$PSI_flipped='Yes'
          }
      }
  }
  #A=Iso2, refIso=Iso1
  else
    {
      indices<-grep('.psi',colnames(spladder_newAndOld))
      for (h in c(1:dim(spladder_newAndOld)[1]))
        {
        if (!is.na(spladder_newAndOld[h,]$refIso)){
          if (spladder_newAndOld[h,]$refIso=='iso1'|| length(grep('Iso2',spladder_newAndOld[h,]$effect_type))==1)
            {
               spladder_newAndOld[h,indices]<-1-spladder_newAndOld[h,indices]
               spladder_newAndOld[h,]$PSI_flipped='Yes'
          }
        }
        }
    }
  #Calculate common part
  count_table<-matrix(0L,nrow=length(unique(spladder_newAndOld$gene_name)),ncol=22)
  rownames(count_table)<-unique(spladder_newAndOld$gene_name)
  colnames(count_table)<-c('WTP_PNSL_1','WTP_SHAM_1','WTP_PNSL_2','WTP_SHAM_2','WTP_PNSL_3','WTP_SHAM_3',
                           'CMV_PNSL_1','CMV_PNSL_2','CMV_PNSL_3','CMV_SHAM_1','CMV_SHAM_2','CMV_SHAM_3',
                           'DLX_PNSL_1','DLX_PNSL_2','DLX_PNSL_3','DLX_SHAM_1','DLX_SHAM_2','DLX_SHAM_3',
                           'NAV_PNSL_2','NAV_PNSL_3','NAV_SHAM_2','NAV_SHAM_3')
  indices<-grep('.psi',colnames(spladder_newAndOld))
  for (g  in c(1:dim(spladder_newAndOld)[1]))
  {
    for (name in colnames(count_table))
    {
      more<-length(which(spladder_newAndOld[g,indices[grep(name,colnames(spladder_newAndOld)[indices])]]>PSI_NaO))
      sample_deviation<-sd(spladder_newAndOld[g,indices[grep(name,colnames(spladder_newAndOld)[indices])]],na.rm=TRUE)
      if (more>=th && sample_deviation<sdTH && is.na(sample_deviation)!=TRUE) #more>=th &&<- threshold dla final filtration
      {
        spladder_newAndOld[g,name]<-'Yes'
        count_table[toString(spladder_newAndOld[g,'gene_name']),name]<-count_table[toString(spladder_newAndOld[g,'gene_name']),name]+1
      }
      else spladder_newAndOld[g,name]<-'No'
    }
  }
  #common- eventy występujące we wszystkich
  Common_all<-apply(spladder_newAndOld[,(dim(spladder_newAndOld)[2]-21):dim(spladder_newAndOld)[2]],1, function(x) sum(x=='Yes'))
  print(length(which(Common_all==22)))
  res_NO[i,j]<-length(which(Common_all==22))
  File_common<-spladder_newAndOld[which(Common_all==22),]
  score<-apply(File_common[,indices],1,mean)
  File_common$Score<-round(score,2)
  File_common_sorted<-File_common[order(File_common$Score,decreasing=TRUE),]
  assign(paste(event,'_newAndOld_common',sep=''),File_common_sorted)
  assign(paste(event,'_newAndOld_count_table',sep=''),count_table)
  #For Unknown and both known = 0.2< all4reps <0.8
  rm(File_common_sorted,count_table)
  names_NN_KK<-c(name_both_new,name_both_known)
  kk<-1
  for (file_to_calc_common in c('spladder_both_new','spladder_both_known'))
  {
    data_to_calc<-get(paste(file_to_calc_common))
    count_table<-matrix(0L,nrow=length(unique(data_to_calc$gene_name)),ncol=22)
    rownames(count_table)<-unique(data_to_calc$gene_name)
    colnames(count_table)<-c('WTP_PNSL_1','WTP_SHAM_1','WTP_PNSL_2','WTP_SHAM_2','WTP_PNSL_3','WTP_SHAM_3',
                           'CMV_PNSL_1','CMV_PNSL_2','CMV_PNSL_3','CMV_SHAM_1','CMV_SHAM_2','CMV_SHAM_3',
                           'DLX_PNSL_1','DLX_PNSL_2','DLX_PNSL_3','DLX_SHAM_1','DLX_SHAM_2','DLX_SHAM_3',
                           'NAV_PNSL_2','NAV_PNSL_3','NAV_SHAM_2','NAV_SHAM_3')
    indices<-grep('.psi',colnames(data_to_calc))
    for (g  in c(1:dim(data_to_calc)[1]))
    {
      for (name in colnames(count_table))
      {
        # more<-length(which(data_to_calc[g,indices[grep(name,colnames(data_to_calc)[indices])]]>PSI_L &
        #                    data_to_calc[g,indices[grep(name,colnames(data_to_calc)[indices])]]<PSI_H))
        sample_deviation<-sd(data_to_calc[g,indices[grep(name,colnames(data_to_calc)[indices])]],na.rm=TRUE)
        if (sample_deviation<sdTH && is.na(sample_deviation)!=TRUE) #more>=th && 
        {
          data_to_calc[g,name]<-'Yes'
          count_table[toString(data_to_calc[g,'gene_name']),name]<-count_table[toString(data_to_calc[g,'gene_name']),name]+1
        }
        else data_to_calc[g,name]<-'No'
      }
    }
  #common- eventy występujące we wszystkich
    Common_all<-apply(data_to_calc[,(dim(data_to_calc)[2]-21):dim(data_to_calc)[2]],1, function(x) sum(x=='Yes'))
    print(length(which(Common_all==22)))
    if(kk==1)
    {
      res_NN[i,j]<-length(which(Common_all==22))
    }
    else res_OO[i,j]<-length(which(Common_all==22))
    File_common<-data_to_calc[which(Common_all==22),]
    score<-apply(File_common[,indices],1,mean)
    File_common$Score<-round(score,2)
    File_common_sorted<-File_common[order(File_common$Score,decreasing=TRUE),]
    assign(paste(event,'_',substring(file_to_calc_common,first=10),'_common',sep=''),File_common_sorted)
    assign(paste(event,'_',substring(file_to_calc_common,first=10),'_count_table',sep=''),count_table)
    assign(paste(names_NN_KK[kk]),data_to_calc)
    kk=kk+1
  }
  assign(name_newAndOld,spladder_newAndOld)
  
  j=j+1
}
  i=i+1
}
events<-c('alt_3_prime','alt_5_prime','exon_skip','mult_exon_skip','mutex_exons')
plot(sd_th,res_NO[,1],type='l',ylim=c(0,5000),col='red',xlab='Sd threshold',ylab='Events detected',main='New and known')
colls<-c('blue','black','cyan','yellow')
j=1
for (i in c(2:5))
{
  lines(sd_th,res_NO[,i],col=colls[j])
  j=j+1
}
legend(0.4,4500,events,fill=c('red',colls),cex=0.7)
j=1
plot(sd_th,res_NN[,1],type='l',ylim=c(0,750),col='red',xlab='Sd threshold',ylab='Events detected', main='Both new')
for (i in c(2:5))
{
  lines(sd_th,res_NN[,i],col=colls[j])
  j=j+1
}
legend(0.1,750,events,fill=c('red',colls),cex=0.7)
j=1
plot(sd_th,res_OO[,1],type='l',ylim=c(0,2000),col='red',xlab='Sd threshold',ylab='Events detected',main='Both known')
for (i in c(2:5))
{
  lines(sd_th,res_OO[,i],col=colls[j])
  j=j+1
}
legend(0.1,2000,events,fill=c('red',colls),cex=0.7)

setwd('/Users/agatamuszynska/Documents/Work/Neuropathy_all_GRcM39/Results_no_PSI_th')
save.image('Final_both_thresholds_grudzien.RData')
```

# Section 1 
## Number of all and common alternative splicing events:
- New/Old PSI>0.5 and sd <0.1
- New/new $ old/old sd<0.1


```{r,warning=FALSE,message=FALSE,fig.align='left'}
BK<-c(dim(alt_3_prime_both_known)[1],dim(alt_5_prime_both_known)[1],dim(exon_skip_both_known)[1],dim(mutex_exons_both_known)[1],dim(mult_exon_skip_both_known)[1])
BK_c<-c(dim(alt_3_prime_both_known_common)[1],dim(alt_5_prime_both_known_common)[1],dim(exon_skip_both_known_common)[1],dim(mutex_exons_both_known_common)[1],dim(mult_exon_skip_both_known_common)[1])
BK_per<-BK_c/BK*100

BN<-c(dim(alt_3_prime_both_new)[1],dim(alt_5_prime_both_new)[1],dim(exon_skip_both_new)[1],dim(mutex_exons_both_new)[1],dim(mult_exon_skip_both_new)[1])
BN_c<-c(dim(alt_3_prime_both_new_common)[1],dim(alt_5_prime_both_new_common)[1],dim(exon_skip_both_new_common)[1],dim(mutex_exons_both_new_common)[1],dim(mult_exon_skip_both_new_common)[1])
BN_per<-BN_c/BN*100

NaO<-c(dim(alt_3_prime_newAndOld)[1],dim(alt_5_prime_newAndOld)[1],dim(exon_skip_newAndOld)[1],dim(mutex_exons_newAndOld)[1],dim(mult_exon_skip_newAndOld)[1])
NaO_c<-c(dim(alt_3_prime_newAndOld_common)[1],dim(alt_5_prime_newAndOld_common)[1],dim(exon_skip_newAndOld_common)[1],dim(mutex_exons_newAndOld_common)[1],dim(mult_exon_skip_newAndOld_common)[1])
NaO_per<-NaO_c/NaO*100
total<-BK+BN+NaO
tab_all<-cbind(BK,BK_c,round(BK_per,digits=2),BN,BN_c,round(BN_per,digits=2),NaO,NaO_c,round(NaO_per,digits=2),total)
colnames(tab_all)<-c('both iso known','both iso known_common','Percentage','both iso new','both iso new common','Percentage','new and old','new and old common','Percentage','Total')

rownames(tab_all)<-c('Alt_3_prime','Alt_5_prime','exon_skip','mutex_exons','mult_exon_skip')
kable(tab_all)
#write.csv(tab_all,"/home/agata/Documents/Work/Dell_work/Neuropathy_all_GRcM39/Tab_all.csv")
count_na <- rowSums(is.na(exon_skip_newAndOld_common))

```
```{r,warning=FALSE,message=FALSE,fig.align='left'}
BKg<-c(length(unique(alt_3_prime_both_known$gene_name)),length(unique(alt_5_prime_both_known$gene_name)),length(unique(exon_skip_both_known$gene_name)),length(unique(mutex_exons_both_known$gene_name)),length(unique(mult_exon_skip_both_known$gene_name)))
BK_cg<-c(length(unique(alt_3_prime_both_known_common$gene_name)),length(unique(alt_5_prime_both_known_common$gene_name)),length(unique(exon_skip_both_known_common$gene_name)),length(unique(mutex_exons_both_known_common$gene_name)),length(unique(mult_exon_skip_both_known_common$gene_name)))
BK_per<-BK_cg/BKg*100
BNg<-c(length(unique(alt_3_prime_both_new$gene_name)),length(unique(alt_5_prime_both_new$gene_name)),length(unique(exon_skip_both_new$gene_name)),length(unique(mutex_exons_both_new$gene_name)),length(unique(mult_exon_skip_both_new$gene_name)))
BN_cg<-c(length(unique(alt_3_prime_both_new_common$gene_name)),length(unique(alt_5_prime_both_new_common$gene_name)),length(unique(exon_skip_both_new_common$gene_name)),length(unique(mutex_exons_both_new_common$gene_name)),length(unique(mult_exon_skip_both_new_common$gene_name)))
BN_per<-BN_cg/BNg*100
NaOg<-c(length(unique(alt_3_prime_newAndOld$gene_name)),length(unique(alt_5_prime_newAndOld$gene_name)),length(unique(exon_skip_newAndOld$gene_name)),length(unique(mutex_exons_newAndOld$gene_name)),length(unique(mult_exon_skip_newAndOld$gene_name)))
NaO_cg<-c(length(unique(alt_3_prime_newAndOld_common$gene_name)),length(unique(alt_5_prime_newAndOld_common$gene_name)),length(unique(exon_skip_newAndOld_common$gene_name)),length(unique(mutex_exons_newAndOld_common$gene_name)),length(unique(mult_exon_skip_newAndOld_common$gene_name)))
NaO_per<-NaO_cg/NaOg*100
total<-BKg+BNg+NaOg
tab_allg<-cbind(BKg,BK_cg,round(BK_per,digits=2),BNg,BN_cg,round(BN_per,digits=2),NaOg,NaO_cg,round(NaO_per,digits=2),total)
colnames(tab_allg)<-c('both iso known','both iso known_common','Percentage','both iso new','both iso new common','Percentage','new and old','new and old common','Percentage','Total')
rownames(tab_allg)<-c('Alt_3_prime','Alt_5_prime','exon_skip','mutex_exons','mult_exon_skip')
kable(tab_allg)
#write.csv(tab_allg,"/home/agata/Documents/Work/Dell_work/Neuropathy_all_GRcM39/Tab_allg.csv")

```